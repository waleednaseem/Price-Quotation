// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for both Admin and Client users
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // null for passwordless clients
  name      String
  role      Role     @default(CLIENT)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdQuotations Quotation[] @relation("CreatedBy")
  negotiations      Negotiation[]
  historyEntries    QuotationHistory[]

  @@map("users")
}

enum Role {
  ADMIN
  CLIENT
}

// Company model
model Company {
  id          String      @id @default(cuid())
  name        String      @unique
  email       String?
  phone       String?
  address     String?
  website     String?
  contactPerson String?
  users       User[]
  quotations  Quotation[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("companies")
}

// Quotation model
model Quotation {
  id             String            @id @default(cuid())
  quotationId    String            @unique // QT-2025-001
  projectName    String
  description    String?
  companyId      String
  company        Company           @relation(fields: [companyId], references: [id])
  createdById    String
  createdBy      User              @relation("CreatedBy", fields: [createdById], references: [id])
  features       Feature[]
  totalCost      Decimal           @default(0)
  deploymentCost Decimal?
  notes          String?
  status         QuotationStatus   @default(PENDING)
  validUntil     DateTime?
  negotiations   Negotiation[]
  history        QuotationHistory[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@map("quotations")
}

enum QuotationStatus {
  PENDING
  NEGOTIATING
  ACCEPTED
  DECLINED
  EXPIRED
}

// Feature model for quotation line items
model Feature {
  id          String    @id @default(cuid())
  title       String
  description String?
  price       Decimal
  quantity    Int       @default(1)
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  isDeleted   Boolean   @default(false)
  deletedBy   String?   // Track who deleted the feature
  order       Int       @default(0) // For ordering features
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("features")
}

// Negotiation model for tracking price negotiations
model Negotiation {
  id             String            @id @default(cuid())
  quotationId    String
  quotation      Quotation         @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  userId         String
  user           User              @relation(fields: [userId], references: [id])
  fromRole       Role
  message        String?
  proposedTotal  Decimal?
  featureChanges Json?             // Store feature-wise price changes
  status         NegotiationStatus @default(PROPOSED)
  respondedAt    DateTime?
  createdAt      DateTime          @default(now())

  @@map("negotiations")
}

enum NegotiationStatus {
  PROPOSED
  ACCEPTED
  DECLINED
  COUNTERED
}

// History model for tracking all quotation changes
model QuotationHistory {
  id          String    @id @default(cuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  action      String    // "created", "updated", "negotiated", "accepted", etc.
  details     Json?     // Store change details
  performedBy String    // User ID
  user        User      @relation(fields: [performedBy], references: [id])
  oldValues   Json?     // Store previous values for comparison
  newValues   Json?     // Store new values
  createdAt   DateTime  @default(now())

  @@map("quotation_history")
}

// Settings model for application configuration
model Settings {
  id                    String   @id @default(cuid())
  companyName           String   @default("Your Company")
  companyLogo           String?
  companyAddress        String?
  companyPhone          String?
  companyEmail          String?
  quotationPrefix       String   @default("QT")
  quotationValidityDays Int      @default(30)
  defaultCurrency       String   @default("USD")
  taxRate               Decimal  @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("settings")
}